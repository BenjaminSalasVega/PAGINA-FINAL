<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Carrito — Viña Urbana</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="theme-dark">
  <!-- AVISO -->
  <div class="announce">
    ENVÍO GRATIS EN RM POR COMPRAS SOBRE $50.000 <small>• 48h hábiles</small>
    <div class="social">
      <a href="#" aria-label="Instagram" title="Instagram">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3a5 5 0 1 1 0 10 5 5 0 0 1 0-10zm6.5-.5a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </svg>
      </a>
      <a href="#" aria-label="Facebook" title="Facebook">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M22 12a10 10 0 1 0-11.6 9.9v-7h-2.1V12h2.1V9.7c0-2 1.2-3.1 3-3.1.9 0 1.8.1 2 .1v2.2h-1.1c-1.1 0-1.4.7-1.4 1.4V12h2.5l-.4 2.9h-2.1v7A10 10 0 0 0 22 12z"/>
        </svg>
      </a>
      <a href="#" aria-label="YouTube" title="YouTube">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M23.5 6.2a3 3 0 0 0-2.1-2.1C19.7 3.5 12 3.5 12 3.5s-7.7 0-9.4.6A3 3 0 0 0 .5 6.2 31 31 0 0 0 0 12a31 31 0 0 0 .5 5.8 3 3 0 0 0 2.1 2.1c1.7.6 9.4.6 9.4.6s7.7 0 9.4-.6a3 3 0 0 0 2.1-2.1A31 31 0 0 0 24 12a31 31 0 0 0-.5-5.8zM9.8 15.5V8.5l6.2 3.5-6.2 3.5z"/>
        </svg>
      </a>
    </div>
  </div>

  <!-- NAV -->
  <nav class="nav glass">
    <div class="container nav-row">
      <a class="logo" href="index3.html">
        <span class="logo-mark">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 2h10v4a5 5 0 1 1-10 0V2zm5 8c3.3 0 6-2.7 6-6H6c0 3.3 2.7 6 6 6zm-1 3v5H8v2h8v-2h-3v-5h-2z"/>
          </svg>
        </span>
        <span class="logo-text">Viña <span>Urbana</span></span>
      </a>

      <div class="search">
        <input placeholder="Busca por cepa, bodega, origen…" aria-label="Buscar vinos">
      </div>

  <div class="menu">
        <a href="catalogo.html">Todos</a>
        <a href="tintos.html">Tintos</a>
        <a href="blancos.html">Blancos</a>
        <a href="rosados.html">Rosados</a>
        <a href="espumantes.html">Espumantes</a>
        <a href="ofertas.html">Ofertas</a>
        <a href="membresia.html">Club</a>
        <a href="tiendas.html">Tiendas</a>
        <a href="empresas.html">Empresas</a>
        <a href="clientes.html">Clientes</a>
        <a href="contacto.html">Contacto</a>
      </div>
      <div class="icons">
        <a class="icon" href="buscar.html" aria-label="Buscar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="11" cy="11" r="7" stroke-width="2"/>
            <path d="M20 20l-3.2-3.2" stroke-width="2"/>
          </svg>
        </a>
        <a class="icon" href="cuenta.html" aria-label="Cuenta">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="8" r="4" stroke-width="2"/>
            <path d="M4 20c2-3 6-5 8-5s6 2 8 5" stroke-width="2"/>
          </svg>
        </a>
        <a class="icon" href="carrito.html" aria-label="Carrito">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M6 8h12l-1 11H7L6 8z" stroke-width="2"/>
            <path d="M9 8V6a3 3 0 0 1 6 0v2" stroke-width="2"/>
          </svg>
        </a>
        <span class="badge cart" title="Productos en carrito" data-cart-count>0</span>
      </div>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <main class="container cart-page" style="padding:32px 0 40px">
    <!-- Pasos del checkout -->
    <header class="cart-header">
      <h1 class="h1">Carrito</h1>
      <ol class="checkout-steps">
        <li class="is-active">1. Carrito</li>
        <li>2. Datos de envío</li>
        <li>3. Pago</li>
        <li>4. Confirmación</li>
      </ol>
    </header>

    <div class="cart-layout">
      <!-- Columna izquierda: productos -->
      <section class="card pad cart-items">
        <div id="cart-empty" class="cart-empty">
          Tu carrito está vacío.  
          <a href="catalogo.html" class="link">Ir al catálogo</a>
        </div>
        <div id="cart-list" class="cart-list"></div>
        <p class="cart-note">
          Los precios incluyen IVA. El stock se confirma al finalizar la compra.
        </p>
      </section>

      <!-- Columna derecha: resumen + tracking -->
      <aside class="cart-aside">
        <section class="card pad cart-summary">
          <h2 class="section-title">Resumen de compra</h2>
          <dl class="totals">
            <div>
              <dt>Subtotal</dt>
              <dd>$ <span id="summary-subtotal">0</span></dd>
            </div>
            <div>
              <dt>Envío</dt>
              <dd id="summary-shipping-label">$ <span id="summary-shipping">0</span></dd>
            </div>
            <div>
              <dt>Descuento</dt>
              <dd>- $ <span id="summary-discount">0</span></dd>
            </div>
            <div class="totals-strong">
              <dt>Total</dt>
              <dd>$ <span id="summary-total">0</span></dd>
            </div>
          </dl>

          <!-- Cupón -->
          <form id="coupon-form" class="coupon">
            <label for="coupon-code">¿Tienes un cupón?</label>
            <div class="coupon-row">
              <input id="coupon-code" placeholder="Ej: URBANA10">
              <button class="btn ghost" type="submit">Aplicar</button>
            </div>
            <small id="coupon-msg" class="coupon-msg"></small>
          </form>

          <button id="btn-checkout" class="btn primary" style="width:100%;margin-top:10px">
            Ir a pagar
          </button>
          <button class="btn ghost" style="width:100%;margin-top:6px" onclick="window.location.href='catalogo.html'">
            Seguir comprando
          </button>

          <p class="delivery-note">
            Envío estándar: 24–48h hábiles en RM.  
            Envío <strong>gratis</strong> sobre $50.000.
          </p>
        </section>

        <!-- Estado del pedido -->
        <section class="card pad tracking-card">
          <h2 class="section-title">Estado de tu pedido</h2>
          <p id="track-empty">
            Aún no tienes pedidos en curso.  
            Cuando completes tu compra podrás ver aquí el estado y recorrido.
          </p>

          <div id="track-info" style="display:none">
            <p class="subtitle" style="margin-bottom:6px">
              Pedido <strong>#<span id="track-id"></span></strong>
            </p>
            <ol class="track-steps">
              <li id="track-step-1">Pedido recibido</li>
              <li id="track-step-2">Preparando despacho</li>
              <li id="track-step-3">En camino</li>
              <li id="track-step-4">Entregado</li>
            </ol>
            <p class="subtitle" style="margin-top:6px">
              Llegada estimada: <span id="track-eta"></span>
            </p>
            <a href="seguimiento.html" class="btn ghost" style="width:100%;margin-top:8px">
              Ver recorrido completo
            </a>
          </div>
        </section>
      </aside>
    </div>
  </main>

  <footer class="container footer">
    <div class="links">
      <a href="politicas.html">Políticas</a>
      <a href="devoluciones.html">Devoluciones</a>
      <a href="contacto.html">Contacto</a>
      <a href="tiendas.html">Tiendas</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="demanda.html">Demanda</a>
      <a href="etiqueta-carbono.html">Etiqueta CO₂</a>
      <a href="donaciones.html">Donaciones</a>
      <a href="vinedos-virtual.html">Viñedos VR</a>
      <a href="maridaje-etiqueta.html">Maridaje AR</a>
    </div>
    <div class="footer-bottom">
      <span>© <span id="y"></span> Viña Urbana</span>
      <span class="footer-badge">+18 | Consume con moderación</span>
    </div>
  </footer>

  <script>
  (function () {
    // Catálogo base con IMÁGENES DESDE INTERNET
    const catalog = [
      {
        id: 'p01',
        name: 'Reserva Especial 2016',
        price: 9690,
        cepa: 'Cabernet Sauvignon',
        year: 2016,
        img: 'https://images.pexels.com/photos/1087927/pexels-photo-1087927.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p02',
        name: 'Reserva Especial 2017',
        price: 10390,
        cepa: 'Sauvignon Blanc',
        year: 2017,
        img: 'https://images.pexels.com/photos/16526849/pexels-photo-16526849.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p03',
        name: 'Reserva Especial 2018',
        price: 11090,
        cepa: 'Cabernet Sauvignon',
        year: 2018,
        img: 'https://images.pexels.com/photos/1407857/pexels-photo-1407857.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p04',
        name: 'Reserva Especial 2019',
        price: 11790,
        cepa: 'Sauvignon Blanc',
        year: 2019,
        img: 'https://images.pexels.com/photos/14799842/pexels-photo-14799842.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p05',
        name: 'Reserva Especial 2020',
        price: 12490,
        cepa: 'Cabernet Sauvignon',
        year: 2020,
        img: 'https://images.pexels.com/photos/3642533/pexels-photo-3642533.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p06',
        name: 'Reserva Especial 2021',
        price: 13190,
        cepa: 'Sauvignon Blanc',
        year: 2021,
        img: 'https://images.pexels.com/photos/19030980/pexels-photo-19030980.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p07',
        name: 'Reserva Especial 2022',
        price: 13890,
        cepa: 'Cabernet Sauvignon',
        year: 2022,
        img: 'https://images.pexels.com/photos/2147791/pexels-photo-2147791.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p08',
        name: 'Reserva Especial 2023',
        price: 14590,
        cepa: 'Sauvignon Blanc',
        year: 2023,
        img: 'https://images.pexels.com/photos/10012572/pexels-photo-10012572.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p09',
        name: 'Reserva Especial 2024',
        price: 15290,
        cepa: 'Cabernet Sauvignon',
        year: 2024,
        img: 'https://images.pexels.com/photos/5531553/pexels-photo-5531553.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p10',
        name: 'Reserva Especial 2025',
        price: 15990,
        cepa: 'Sauvignon Blanc',
        year: 2025,
        img: 'https://images.pexels.com/photos/34926023/pexels-photo-34926023.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p11',
        name: 'Reserva Especial 2026',
        price: 16690,
        cepa: 'Cabernet Sauvignon',
        year: 2026,
        img: 'https://images.pexels.com/photos/2148053/pexels-photo-2148053.jpeg?auto=compress&cs=tinysrgb&w=600'
      },
      {
        id: 'p12',
        name: 'Reserva Especial 2027',
        price: 17390,
        cepa: 'Sauvignon Blanc',
        year: 2027,
        img: 'https://images.pexels.com/photos/15809237/pexels-photo-15809237.jpeg?auto=compress&cs=tinysrgb&w=600'
      }
    ];

    const listEl = document.getElementById('cart-list');
    const emptyEl = document.getElementById('cart-empty');

    const subtotalEl = document.getElementById('summary-subtotal');
    const shippingEl = document.getElementById('summary-shipping');
    const shippingLabelEl = document.getElementById('summary-shipping-label');
    const discountEl = document.getElementById('summary-discount');
    const totalEl = document.getElementById('summary-total');

    const couponForm = document.getElementById('coupon-form');
    const couponCodeEl = document.getElementById('coupon-code');
    const couponMsgEl = document.getElementById('coupon-msg');
    const checkoutBtn = document.getElementById('btn-checkout');

    let cart = loadCart();
    let coupon = { code: null, amount: 0 };

    renderCart();
    loadTracking();

    // ---- Funciones de carrito ----
    function loadCart() {
      const raw = JSON.parse(localStorage.getItem('vu_cart') || '[]');
      const map = new Map();

      raw.forEach(entry => {
        let id, qty;
        if (typeof entry === 'string') {
          id = entry;
          qty = 1;
        } else if (entry && entry.id) {
          id = entry.id;
          qty = entry.qty || 1;
        }
        if (!id) return;
        const current = map.get(id) || 0;
        map.set(id, current + qty);
      });

      return Array.from(map.entries()).map(([id, qty]) => ({ id, qty }));
    }

    function saveCart() {
      localStorage.setItem('vu_cart', JSON.stringify(cart));
    }

    function renderCart() {
      listEl.innerHTML = '';
      if (!cart.length) {
        emptyEl.style.display = 'block';
      } else {
        emptyEl.style.display = 'none';
      }

      let subtotal = 0;
      cart.forEach(line => {
        const product = catalog.find(p => p.id === line.id);
        if (!product) return;
        const lineTotal = product.price * line.qty;
        subtotal += lineTotal;

        const row = document.createElement('article');
        row.className = 'cart-row';
        row.dataset.id = line.id;
        row.innerHTML = `
          <div class="cart-row-main">
            <img class="cart-thumb" src="${product.img}" alt="${product.name}">
            <div class="cart-row-info">
              <h3>${product.name}</h3>
              <p class="subtitle">
                ${product.cepa} • ${product.year} • $ ${product.price.toLocaleString('es-CL')}
              </p>
            </div>
          </div>
          <div class="cart-row-actions">
            <div class="qty-control">
              <button type="button" class="qty-btn" data-op="minus">−</button>
              <input type="number" min="1" value="${line.qty}" class="qty-input">
              <button type="button" class="qty-btn" data-op="plus">+</button>
            </div>
            <div class="cart-row-subtotal">
              $ <span>${lineTotal.toLocaleString('es-CL')}</span>
            </div>
            <button type="button" class="link cart-remove">Quitar</button>
          </div>
        `;
        listEl.appendChild(row);
      });

      // Resumen
      const shipping = subtotal === 0 ? 0 : (subtotal >= 50000 ? 0 : 3990);
      coupon.amount = coupon.code ? Math.round(subtotal * 0.10) : 0;
      const total = Math.max(subtotal + shipping - coupon.amount, 0);

      subtotalEl.textContent = subtotal.toLocaleString('es-CL');
      shippingEl.textContent = shipping.toLocaleString('es-CL');
      shippingLabelEl.textContent = shipping === 0 && subtotal > 0 ? 'Gratis' : '$ ' + shipping.toLocaleString('es-CL');
      discountEl.textContent = coupon.amount.toLocaleString('es-CL');
      totalEl.textContent = total.toLocaleString('es-CL');

      attachRowEvents();
    }

    function attachRowEvents() {
      document.querySelectorAll('.cart-row').forEach(row => {
        const id = row.dataset.id;
        const minus = row.querySelector('[data-op="minus"]');
        const plus = row.querySelector('[data-op="plus"]');
        const input = row.querySelector('.qty-input');
        const removeBtn = row.querySelector('.cart-remove');

        minus.addEventListener('click', () => changeQty(id, parseInt(input.value || '1', 10) - 1));
        plus.addEventListener('click', () => changeQty(id, parseInt(input.value || '1', 10) + 1));
        input.addEventListener('change', () => changeQty(id, parseInt(input.value || '1', 10)));
        removeBtn.addEventListener('click', () => removeLine(id));
      });
    }

    function changeQty(id, newQty) {
      if (isNaN(newQty) || newQty < 1) newQty = 1;
      const line = cart.find(l => l.id === id);
      if (!line) return;
      line.qty = newQty;
      saveCart();
      renderCart();
    }

    function removeLine(id) {
      cart = cart.filter(l => l.id !== id);
      saveCart();
      renderCart();
    }

    // ---- Cupón ----
    couponForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const code = (couponCodeEl.value || '').trim().toUpperCase();
      if (!code) {
        coupon = { code: null, amount: 0 };
        couponMsgEl.textContent = 'Ingresa un código válido.';
        couponMsgEl.style.color = '#fca5a5';
      } else if (code === 'URBANA10') {
        coupon = { code, amount: 0 }; // se recalcula en renderCart
        couponMsgEl.textContent = 'Cupón aplicado: 10% de descuento sobre el subtotal.';
        couponMsgEl.style.color = '#bbf7d0';
      } else {
        coupon = { code: null, amount: 0 };
        couponMsgEl.textContent = 'Código inválido o expirado.';
        couponMsgEl.style.color = '#fca5a5';
      }
      renderCart();
    });

    // ---- Simulación checkout / pedido ----
    checkoutBtn.addEventListener('click', function () {
      if (!cart.length) {
        alert('Tu carrito está vacío.');
        return;
      }
      const subtotal = cart.reduce((acc, line) => {
        const p = catalog.find(x => x.id === line.id);
        return acc + (p ? p.price * line.qty : 0);
      }, 0);
      const shipping = subtotal >= 50000 ? 0 : 3990;
      const discount = coupon.code ? Math.round(subtotal * 0.10) : 0;
      const total = subtotal + shipping - discount;

      const orderId = 'VU' + Date.now().toString().slice(-6);
      const order = {
        id: orderId,
        total,
        eta: '24–48 horas hábiles',
        currentStep: 2 // 1: recibido, 2: preparando, 3: en camino, 4: entregado
      };
      localStorage.setItem('vu_last_order', JSON.stringify(order));

      alert('Compra simulada.\nNúmero de pedido: ' + orderId + '\nTotal: $ ' + total.toLocaleString('es-CL'));
      // Aquí podrías redirigir a una página de seguimiento real:
      // window.location.href = 'seguimiento.html';
      loadTracking();
    });

    // ---- Tracking de pedido ----
    function loadTracking() {
      const trackEmpty = document.getElementById('track-empty');
      const trackInfo = document.getElementById('track-info');
      const data = localStorage.getItem('vu_last_order');
      if (!data) {
        trackEmpty.style.display = 'block';
        trackInfo.style.display = 'none';
        return;
      }
      const order = JSON.parse(data);
      document.getElementById('track-id').textContent = order.id;
      document.getElementById('track-eta').textContent = order.eta;

      const steps = [1, 2, 3, 4];
      steps.forEach(n => {
        const li = document.getElementById('track-step-' + n);
        li.classList.remove('is-done', 'is-active');
        if (n < order.currentStep) li.classList.add('is-done');
        if (n === order.currentStep) li.classList.add('is-active');
      });

      trackEmpty.style.display = 'none';
      trackInfo.style.display = 'block';
    }
  })();
  </script>

  <script src="scripts.js"></script>
  <script>try{runSearch();}catch(e){}</script>
</body>
</html>
